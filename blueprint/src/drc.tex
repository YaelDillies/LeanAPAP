\chapter{Dependent random choice}


\begin{lemma}
\label{lem-drc}
\lean{drc}
\leanok
Let $p\geq 2$ be an even integer. Let $B_1,B_2\subseteq G$ and $\mu=\mu_{B_1}\circ\mu_{B_2}$. For any finite set $A\subseteq G$ and function $f:G\to\bbr_{\geq 0}$ there exist $A_1\subseteq B_1$ and $A_2\subseteq B_2$ such that
\[\langle \mu_{A_1}\circ \mu_{A_2}, f\rangle \norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p\leq 2\langle (\ind{A}\circ \ind{A})^p,f\rangle_\mu\]
and
\[\min\brac{\frac{\abs{A_1}}{\abs{B_1}},\frac{\abs{A_2}}{\abs{B_2}}}\geq \frac{1}{4}\abs{A}^{-2p}\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^{2p}.\]
\end{lemma}

\begin{proof}
\leanok
First note that the statement is trivially true (with $A_1=B_1$ and $A_2=B_2$, say) if $\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p=0$. We can therefore assume this is $\neq 0$.

For $s\in G^{p}$ let $A_1(s)=B_1\cap (A+s_1)\cap\cdots\cap (A+s_{p})$, and similarly for $A_2(s)$. Note that
\begin{align*}
\langle (\ind{A}\circ \ind{A})^p, f\rangle_\mu
&=\sum_{x} \mu_{B_1}\circ \mu_{B_2}(x)(\ind{A}\circ \ind{A}(x))^pf(x)\\
&=\sum_{b_1,b_2}\mu_{B_1}(b_1)\mu_{B_2}(b_2)\ind{A}\circ \ind{A}(b_1-b_2)^{p}f(b_1-b_2)\\
&=\sum_{b_1,b_2}\mu_{B_1}(b_1)\mu_{B_2}(b_2)\brac{\sum_{t\in G}\ind{A+t}(b_1)\ind{A+t}(b_2)}^{p}f(b_1-b_2)\\
&=\sum_{b_1,b_2}\mu_{B_1}(b_1)\mu_{B_2}(b_2)\sum_{s\in G^p}\ind{A_1(s)}(b_1)\ind{A_2(s)}(b_2)f(b_1-b_2)\\
&=\abs{B_1}^{-1}\abs{B_2}^{-1}\sum_{s\in G^p}\langle \ind{A_1(s)}\circ \ind{A_2(s)}, f\rangle.
\end{align*}
In particular, applying this with $f\equiv 1$ we see that
\[\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p=\abs{B_1}^{-1}\abs{B_2}^{-1}\sum_s\abs{A_1(s)}\abs{A_2(s)}\]
and
\[\frac{\langle (\ind{A}\circ \ind{A})^p,f\rangle_\mu}{\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p}=\frac{\sum_{s}\langle \ind{A_1(s)}\circ \ind{A_2(s)}, f\rangle}{\sum_s \abs{A_1(s)}\abs{A_2(s)}}=\eta,\]
say. Let $M>0$ be some parameter, and let
\[g(s) = \begin{cases} 1&\textrm{ if }0<\abs{A_1(s)}\abs{A_2(s)}<M^2\textrm{ and }\\0&\textrm{ otherwise.}\end{cases}\]
Then we have
\[\sum_s g(s)\abs{A_1(s)}\abs{A_2(s)}
<\sum_s M\abs{A_1(s)}^{1/2}\abs{A_2(s)}^{1/2}.\]
To see why, note first that each summand on the left-hand side is $\leq$ the corresponding summand on the right-hand side, arguing by cases on whether $g(s)=1$ or not. It therefore suffices to show that there exists some $s$ such that the summand on the left-hand side is $<$ the corresponding summand on the right-hand side.

If $g(s)=0$ for all $s$ then choose some $s$ such that $\abs{A_1(s)}\abs{A_2(s)}\geq M^2$ (this must exist or else $\abs{A_1(s)}\abs{A_2(s)}=0$ for all $s$, but then $\norm{1_A\circ 1_A}_{p(\mu)}^p=0$ by the above calculation). Otherwise, choose some $s$ such that $g(s)=1$, and note that for this $s$ we have, by definition of $s$,
\[\abs{A_1(s)}\abs{A_2(s)}<M\abs{A_1(s)}^{1/2}\abs{A_2(s)}^{1/2}.\]

We now choose
\[M=\tfrac{1}{2}\abs{A}^{-p}(\abs{B_1}\abs{B_2})^{1/2}\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p,\]
so that, by the Cauchy-Schwarz inequality,
\begin{align*}
\sum_s g(s)\abs{A_1(s)}\abs{A_2(s)}
&< M \sum_s \abs{A_1(s)}^{1/2}\abs{A_2(s)}^{1/2}\\
&\leq M\brac{\sum_s \sum_{x\in G}1_{A_1(s)}(x)}^{1/2}\brac{\sum_s \sum_{x\in G}1_{A_2(s)}(x)}^{1/2}\\
&= M\abs{A}^p(\abs{B_1}\abs{B_2})^{1/2}\\
&=\frac{1}{2}\sum_s \abs{A_1(s)}\abs{A_2(s)}
\end{align*}
and so
\[
\sum_s (1-g(s))\abs{A_1(s)}\abs{A_2(s)}
> \frac{1}{2}\sum_s \abs{A_1(s)}\abs{A_2(s)}\]
whence
\[\sum_s\langle \ind{A_1(s)}\circ \ind{A_2(s)},f\rangle =\eta \sum \abs{A_1(s)}\abs{A_2(s)}
< 2\eta \sum_s \abs{A_1(s)}\abs{A_2(s)}(1-g(s)).\]
In particular there must exist some $s$ such that
\[\langle \ind{A_1(s)}\circ \ind{A_2(s)},f\rangle< 2\eta \abs{A_1(s)}\abs{A_2(s)}(1-g(s)).\]
We claim this $s$ meets the requirements. The first is satisfied since the right-hand side is $\leq 2\eta \abs{A_1(s)}\abs{A_2(s)}$. The second is satisfied since the left-hand side is trivially $\geq 0$ and hence such an $s$ must satisfy $g(s)=0$, whence either $ \abs{A_1(s)}\abs{A_2(s)}\geq M^2$, that is,
\[\abs{A_1(s)}\abs{A_2(s)}\geq \frac{1}{4}\abs{A}^{-2p}\abs{B_1}\abs{B_2}\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^{2p},\]
or $\abs{A_1(s)}\abs{A_2(s)}=0$, which can't happen because then the right-hand side is $=0$.

The final bound now follows since $xy \leq \min(x,y)$ when $x,y\leq 1$.
\end{proof}


\begin{lemma}
\label{lem-sift}
\lean{sifting}
\leanok
Let $\epsilon,\delta >0$ and $p\geq \max(2,\epsilon^{-1}\log(2/\delta))$ be an even integer. Let $B_1,B_2\subseteq G$, and let $\mu=\mu_{B_1}\circ\mu_{B_2}$. For any finite set $A\subseteq G$, if
\[S=\{ x\in G: \ind{A}\circ \ind{A}(x)>(1-\epsilon)\norm{\ind{A}\circ \ind{A}}_{p(\mu)}\},\]
then there are $A_1\subseteq B_1$ and $A_2\subseteq B_2$ such that
\[\langle \mu_{A_1}\circ\mu_{A_2},\ind{S}\rangle \geq 1-\delta\]
and
\[\min\brac{\frac{\abs{A_1}}{\abs{B_1}},\frac{\abs{A_2}}{\abs{B_2}}}\geq \frac{1}{4}\abs{A}^{-2p}\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^{2p}.\]
\end{lemma}

\begin{proof}
\uses{lem-drc}
\leanok
Apply Lemma~\ref{lem-drc} with $f=\ind{G\backslash S}$. This produces some $A_1\subseteq B_1$ and $A_2\subseteq B_2$ such that
\[\langle \mu_{A_1}\circ \mu_{A_2}, \ind{G\backslash S}\rangle\leq 2\frac{\langle (\ind{A}\circ \ind{A})^p,\ind{G\backslash S}\rangle_\mu}{\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p}\]
and
\[\min\brac{\frac{\abs{A_1}}{\abs{B_1}},\frac{\abs{A_2}}{\abs{B_2}}}\geq \frac{1}{4}\abs{A}^{-2p}\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^{2p}.\]
It then suffices to note that
\[\langle \mu_{A_1}\circ \mu_{A_2},\ind{S}\rangle=1-\langle \mu_{A_1}\circ \mu_{A_2},\ind{G\backslash S}\rangle\]
and by definition of $S$ we have
\[\langle (\ind{A}\circ \ind{A})^p,\ind{G\backslash S}\rangle_\mu\leq (1-\epsilon)^p\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p\sum_{x}\mu(x)=(1-\epsilon)^p\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p.\]
Now use the fact that $p\geq \epsilon^{-1}\log(2/\delta)$ together with the inequality $1-x\leq e^{-x}$ to deduce that the right-hand side is $\leq \tfrac{\delta}{2}\norm{\ind{A}\circ \ind{A}}_{p(\mu)}^p$.
\end{proof}



\begin{corollary}\label{cor_sifting}
Let $\epsilon,\delta>0$ and $p\geq \max(2,\epsilon^{-1}\log(2/\delta))$ be an even integer and $\mu\equiv 1/N$. If $A\subseteq G$ has density $\alpha$ and
\[S = \{ x : \mu_A\circ \mu_A(x) \geq (1-\epsilon)\| \mu_A\circ \mu_A\|_{p(\mu)}\}\]
then there are $A_1,A_2\subseteq G$ such that
\[\langle \mu_{A_1}\circ \mu_{A_2}, 1_S\rangle \geq 1-\delta\]
and both $A_1$ and $A_2$ have density
\[\geq \frac{1}{4}\alpha^{2p}.\]
\end{corollary}
\begin{proof}
\uses{lem-sift}
We apply Lemma~\ref{lem-sift} with $B_1=B_2=G$. It remains to note that 
\[\| 1_A\circ 1_A\|_{p(\mu)}\geq \| 1_A\circ 1_A\|_{1(\mu)}=\lvert A\rvert^2/N.\]
\end{proof}
